

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>How to Open and View CMAQ simulations - HI Volcano Example &mdash; MONET  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NOAA NESDIS AOD" href="NESDIS_VIIRS_AOD.html" />
    <link rel="prev" title="Loading IMPROVE Data" href="improve_trends_kmeans.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html">
          

          
            
            <img src="../_static/MONET-logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Getting Started</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../why-monet.html">Overview: Why MONET?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installing.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monet-accessor.html">MONET XArray Accessor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../observations.html">Observations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models.html">Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorial.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="aqs_pams.html">How to read AQS data from PAMS and do a quick analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="improve_trends_kmeans.html">Loading IMPROVE Data</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">How to Open and View CMAQ simulations - HI Volcano Example</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plotting-on-a-map">Plotting on a map</a></li>
<li class="toctree-l3"><a class="reference internal" href="#finding-nearest-lat-lon-point">Finding nearest lat lon point</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pairing-with-airnow">Pairing with AirNow</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overlaying-observations-on-contour-plots">Overlaying Observations on Contour Plots</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="NESDIS_VIIRS_AOD.html">NOAA NESDIS AOD</a></li>
<li class="toctree-l2"><a class="reference internal" href="fv3chem_tutorial.html">FV3-CHEM in MONET</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../monet_wcoss.html">MONET on WCOSS</a></li>
</ul>
<p class="caption"><span class="caption-text">Help * Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">Get in touch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html#api">API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">MONET</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../tutorial.html">Tutorial</a> &raquo;</li>
        
      <li>How to Open and View CMAQ simulations - HI Volcano Example</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/CMAQ_hi_volcano.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="how-to-open-and-view-cmaq-simulations-hi-volcano-example">
<h1>How to Open and View CMAQ simulations - HI Volcano Example<a class="headerlink" href="#how-to-open-and-view-cmaq-simulations-hi-volcano-example" title="Permalink to this headline">Â¶</a></h1>
<p>In this example, we will learn how to open CMAQ simulations using MONET,
view the data on a map, view cross sections of the data, and compare to
surface observations (AirNow) for the May 2018 Hawaiian volcanic
eruption. First, import MONET and several helper functions for later.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">monet.obs</span> <span class="k">import</span> <span class="n">airnow</span>
<span class="kn">from</span> <span class="nn">monet.models</span> <span class="k">import</span> <span class="n">cmaq</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">monet.util</span> <span class="k">import</span> <span class="n">tools</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
<p>Now the data can be downloaded from the MONET github page in the
MONET/data directory. We will assume you already have this downloaded
and will proceed. Open the simulation. As of right now we still require
that a seperate grdcro2d (grddot2d) file be loaded for the mass points
(dot points) using the <code class="docutils literal notranslate"><span class="pre">grid</span></code> kwarg.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conc</span> <span class="o">=</span> <span class="s1">&#39;/Users/barry/Desktop/MONET/data/aqm.t12z.aconc.ncf&#39;</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">cmaq</span><span class="o">.</span><span class="n">open_dtaset</span><span class="p">(</span><span class="n">flist</span><span class="o">=</span><span class="n">conc</span><span class="p">)</span>
</pre></div>
</div>
<p>The cmaq object will return a <code class="docutils literal notranslate"><span class="pre">xarray.Dataset</span></code> but it also still lives
inside of the <code class="docutils literal notranslate"><span class="pre">cmaq</span></code> object in <code class="docutils literal notranslate"><span class="pre">cmaq.dset</span></code>. We may use a combination
of both the dataset (c) directly and the cmaq calls to gather or
aggrigate species in the concentration file.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span>
</pre></div>
</div>
<pre class="literal-block">
&lt;xarray.Dataset&gt;
Dimensions:    (DATE-TIME: 2, VAR: 41, time: 48, x: 80, y: 52, z: 1)
Coordinates:
* time       (time) datetime64[ns] 2018-05-17T12:00:00 2018-05-17T13:00:00 ...
  longitude  (y, x) float64 -161.9 -161.8 -161.7 -161.6 -161.5 -161.4 ...
  latitude   (y, x) float64 17.76 17.76 17.77 17.77 17.77 17.77 17.78 ...
Dimensions without coordinates: DATE-TIME, VAR, x, y, z
Data variables:
  TFLAG      (time, VAR, DATE-TIME) int32 ...
  O3         (time, z, y, x) float32 28.296675 28.461445 28.483536 ...
  NO2        (time, z, y, x) float32 0.0072615896 0.007076008 0.0070880884 ...
  NO         (time, z, y, x) float32 1.6760728e-08 1.6089658e-08 ...
  NO3        (time, z, y, x) float32 0.0022378012 0.0022129775 ...
  N2O5       (time, z, y, x) float32 8.560217e-06 8.241847e-06 ...
  HNO3       (time, z, y, x) float32 0.1326946 0.13388994 0.1343063 ...
  HONO       (time, z, y, x) float32 6.2205704e-06 5.9552485e-06 ...
  PNA        (time, z, y, x) float32 2.1638462e-07 1.9233373e-07 ...
  CO         (time, z, y, x) float32 72.599915 72.56304 72.599266 ...
  FORM       (time, z, y, x) float32 0.3351323 0.3413216 0.34457546 ...
  ALD2       (time, z, y, x) float32 0.13579664 0.12625198 0.1253843 ...
  PAN        (time, z, y, x) float32 0.00054027676 0.00047953427 ...
  NTR        (time, z, y, x) float32 0.0057188044 0.0053887735 0.005364259 ...
  XO2N       (time, z, y, x) float32 2.1813818e-05 2.1018073e-05 ...
  SO2        (time, z, y, x) float32 0.009011468 0.009855208 0.009888159 ...
  ASO4I      (time, z, y, x) float32 0.00071987335 0.0006097436 ...
  ASO4J      (time, z, y, x) float32 0.6792807 0.68186235 0.6739671 ...
  ANH4I      (time, z, y, x) float32 5.4321783e-05 4.6263896e-05 ...
  ANH4J      (time, z, y, x) float32 0.051220056 0.051677197 0.05048342 ...
  ANO3I      (time, z, y, x) float32 9.547329e-16 8.1884126e-16 ...
  ANO3J      (time, z, y, x) float32 8.933346e-13 9.0928e-13 5.418493e-05 ...
  AORGAI     (time, z, y, x) float32 1.4356241e-10 1.308317e-10 ...
  AORGAJ     (time, z, y, x) float32 1.2230534e-05 1.1428401e-05 ...
  AORGPAI    (time, z, y, x) float32 6.7508597e-07 6.614316e-07 ...
  AORGPAJ    (time, z, y, x) float32 0.05786852 0.058112975 0.05817498 ...
  AORGBI     (time, z, y, x) float32 6.7122006e-09 6.5227788e-09 ...
  AORGBJ     (time, z, y, x) float32 0.0005746193 0.00057244353 ...
  AECI       (time, z, y, x) float32 2.4381194e-07 2.3888646e-07 ...
  AECJ       (time, z, y, x) float32 0.014596849 0.014644699 0.014672826 ...
  A25I       (time, z, y, x) float32 ...
  A25J       (time, z, y, x) float32 ...
  NUMATKN    (time, z, y, x) float32 ...
  NUMACC     (time, z, y, x) float32 ...
  SRFATKN    (time, z, y, x) float32 ...
  SRFACC     (time, z, y, x) float32 ...
  AH2OI      (time, z, y, x) float32 ...
  AH2OJ      (time, z, y, x) float32 ...
  ACLI       (time, z, y, x) float32 ...
  ACLJ       (time, z, y, x) float32 3.5000003e-13 3.5000003e-13 ...
  ANAI       (time, z, y, x) float32 8.394818e-17 8.4039525e-17 ...
  ANAJ       (time, z, y, x) float32 0.2311452 0.23135261 0.23287562 ...
  PM25       (time, z, y, x) float32 1.0354732 1.0388906 1.0314605 ...
  PM10       (time, z, y, x) float32 1.0354732 1.0388906 1.0314605 ...
  CLf        (time, z, y, x) float32 3.5000003e-13 3.5000003e-13 ...
  NAf        (time, z, y, x) float32 0.2311452 0.23135261 0.23287562 ...
  NOy        (time, z, y, x) float32 0.0001484681 0.00014906164 ...
  NOx        (time, z, y, x) float32 1.6760728e-11 1.6089657e-11 ...
  NO3f       (time, z, y, x) float32 8.9428936e-13 9.100988e-13 ...
  NH4f       (time, z, y, x) float32 0.051274378 0.05172346 0.050527096 ...
  SO4f       (time, z, y, x) float32 0.68000054 0.6824721 0.67454904 ...
Attributes:
  IOAPI_VERSION:   $Id: &#64;(#) ioapi library version 3.1 $                   ...
  EXEC_ID:         ????????????????                                        ...
  FTYPE:           1
  CDATE:           2018142
  CTIME:           135716
  WDATE:           2018142
  WTIME:           135716
  SDATE:           2018137
  STIME:           120000
  TSTEP:           10000
  NTHIK:           1
  NCOLS:           80
  NROWS:           52
  NLAYS:           1
  NVARS:           41
  GDTYP:           2
  P_ALP:           19.0
  P_BET:           21.0
  P_GAM:           -157.5
  XCENT:           -157.5
  YCENT:           20.53
  XORIG:           -480000.0
  YORIG:           -312000.0
  XCELL:           12000.0
  YCELL:           12000.0
  VGTYP:           1
  VGTOP:           200.0
  VGLVLS:          [1.       0.089794]
  GDNAM:           AQF_HI
  UPNAM:           OPACONC
  VAR-LIST:        O3              NO2             NO              NO3     ...
  FILEDESC:        Concentration file output                               ...
  HISTORY:
  proj4_srs:       +proj=lcc +lat_1=19.0 +lat_2=21.0 +lat_0=20.53 +lon_0=-1...
  area:            Area ID: MONET_Object_GridnDescription: IOAPI area_def ...
  mapping_tables:  {'improve': {}, 'aqs': {'OZONE': ['O3'], 'PM2.5': ['PM25...
</pre>
<p>Notice that this looks like the ncdump of the file except that there are
seperate coordinates including the latitude and longitude and the time
as numpy.datetime64 objects. Also included is the proj4 string, a pyresample area grid
and default mapping tables to several different observational datasets.</p>
<div class="section" id="plotting-on-a-map">
<h2>Plotting on a map<a class="headerlink" href="#plotting-on-a-map" title="Permalink to this headline">Â¶</a></h2>
<p>It is often useful to be able to view the data on a map. Letâs view a
random time slice of SO2 (we will view time 20 hours into the
simulation).</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">SO2</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">monet</span><span class="o">.</span><span class="n">quick_map</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.4s</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">QuadMesh</span> <span class="n">at</span> <span class="mh">0x1c27910860</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_7_2.png" src="../_images/CMAQ_hi_volcano_7_2.png" />
<p>Now this doesnât look very pretty. First it isnât on a map, the color
scale isnât good as we cannot really see any of the data. To fix this we
will add a map using the MONETAccessor and use the <code class="docutils literal notranslate"><span class="pre">robust=True</span></code> kwarg.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">SO2</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">monet</span><span class="o">.</span><span class="n">quick_map</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_9_2.png" src="../_images/CMAQ_hi_volcano_9_2.png" />
<p>Better but we can still do much more. There is low concentrations on
most of this map making it hard to notice the extremely high values and
the SO2 data is in ppmv and not ppbv as normally viewed as. Also, a
logscale may be better fo this type of data as it goes from 0-20000 ppbv
rather than a linear scale.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="k">import</span> <span class="n">LogNorm</span>
<span class="c1"># convert to ppbv</span>
<span class="n">so2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">SO2</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">,:,:]</span>
<span class="n">so2</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">so2</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">monet</span><span class="o">.</span><span class="n">quick_map</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_11_3.png" src="../_images/CMAQ_hi_volcano_11_3.png" />
<p>Now letâs us view serveral time slices at once. We will average in time
(every 8 hours) to give us 6 total subplots.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">SO2</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">*</span> <span class="mf">1000.</span>
<span class="n">so2_resampled</span> <span class="o">=</span> <span class="n">so2</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;8H&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sortby</span><span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">so2_resampled</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">col_wrap</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="n">subplot_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()})</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">so2</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">so2</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">so2</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">so2</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">flat</span><span class="p">:</span>
    <span class="n">draw_map</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span><span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_15_1.png" src="../_images/CMAQ_hi_volcano_15_1.png" />
</div>
<div class="section" id="finding-nearest-lat-lon-point">
<h2>Finding nearest lat lon point<a class="headerlink" href="#finding-nearest-lat-lon-point" title="Permalink to this headline">Â¶</a></h2>
<p>Suppose that we want to find the model data found at a point
(latitude,longitude). Use the MONETAccessor again</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so2</span><span class="o">.</span><span class="n">monet</span><span class="o">.</span><span class="n">nearest_latlon</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="mf">20.5</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="mf">157.5</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_17_2.png" src="../_images/CMAQ_hi_volcano_17_2.png" />
</div>
<div class="section" id="pairing-with-airnow">
<h2>Pairing with AirNow<a class="headerlink" href="#pairing-with-airnow" title="Permalink to this headline">Â¶</a></h2>
<p>It is often useful to be able to pair model data with observational
data. MONET uses the pyresample library
(<a class="reference external" href="http://pyresample.readthedocs.io/en/latest/">http://pyresample.readthedocs.io/en/latest/</a>) to do a nearest neighbor
interpolation. First let us get the airnow data for the dates of the
simulation. We will also rotate it from the raw AirNow long format (stacked variables) to a wide format (each variable is a seperate column)</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">monet.util</span> <span class="k">import</span> <span class="n">tools</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">airnow</span><span class="o">.</span><span class="n">add_data</span><span class="p">(</span><span class="n">so2</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_index</span><span class="p">())</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">tools</span><span class="o">.</span><span class="n">long_to_wide</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Aggregating</span> <span class="n">AIRNOW</span> <span class="n">files</span><span class="o">...</span>
<span class="n">Building</span> <span class="n">AIRNOW</span> <span class="n">URLs</span><span class="o">...</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  1.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  1.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  1.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  1.5s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  1.5s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed | 12.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed | 12.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed | 12.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed | 12.5s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed | 12.6s</span>
    <span class="n">Adding</span> <span class="ow">in</span> <span class="n">Meta</span><span class="o">-</span><span class="n">data</span>
</pre></div>
</div>
<p>Now let us combine the two. This will return the pandas dataframe with a
new column (model).</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_combined</span> <span class="o">=</span> <span class="n">so2</span><span class="o">.</span><span class="n">monet</span><span class="o">.</span><span class="n">combine_point</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s1">&#39;SO2&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
</pre></div>
</div>
<p>Letâs look at the distributions to see if the two overlap to get a
general scence of performance.</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df_so2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="o">.</span><span class="n">variable</span> <span class="o">==</span> <span class="s1">&#39;SO2&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">state_name</span> <span class="o">==</span> <span class="s1">&#39;HI&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;obs&#39;</span><span class="p">])</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">f</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">df_so2</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">df_so2</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">clip</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">500</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">_subplots</span><span class="o">.</span><span class="n">AxesSubplot</span> <span class="n">at</span> <span class="mh">0x1c290e94a8</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_25_1.png" src="../_images/CMAQ_hi_volcano_25_1.png" />
</div>
<div class="section" id="overlaying-observations-on-contour-plots">
<h2>Overlaying Observations on Contour Plots<a class="headerlink" href="#overlaying-observations-on-contour-plots" title="Permalink to this headline">Â¶</a></h2>
<p>Now letâs put a time slice on a map. Letâs look back to the time step
â2018-05-18 03:00â,</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">monet.plots</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">draw_map</span><span class="p">(</span><span class="n">states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">so2_now</span> <span class="o">=</span> <span class="n">so2</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;2018-05-18 03:00&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">so2_now</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span><span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;SO2 (ppbv)&#39;</span><span class="p">})</span>
<span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">df_so2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_so2</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="s1">&#39;2018-05-18 03:00&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="s1">&#39;subplot_kw&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">cartopy</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1c27451d00</span><span class="o">&gt;</span><span class="p">}}</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.4s</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span> <span class="n">at</span> <span class="mh">0x1c2ae207b8</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_27_2.png" src="../_images/CMAQ_hi_volcano_27_2.png" />
<p>Not bad but again we can do a little better with the scatter plot. Itâs
hard to see the outlines of the observations when there is high
correlation, the sizes may be a little large</p>
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">draw_map</span><span class="p">(</span><span class="n">states</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;10m&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>

<span class="n">so2_now</span> <span class="o">=</span> <span class="n">so2</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;2018-05-18 03:00&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">so2_now</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(),</span><span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;SO2 (ppbv)&#39;</span><span class="p">})</span>
<span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_clim</span><span class="p">()</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">df_so2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_so2</span><span class="o">.</span><span class="n">time</span> <span class="o">==</span> <span class="s1">&#39;2018-05-18 03:00&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">longitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">d</span><span class="o">.</span><span class="n">latitude</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=.</span><span class="mi">25</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="s1">&#39;subplot_kw&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">cartopy</span><span class="o">.</span><span class="n">crs</span><span class="o">.</span><span class="n">PlateCarree</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x1c2b0ead00</span><span class="o">&gt;</span><span class="p">}}</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.1s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.2s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.3s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.4s</span>
<span class="p">[</span><span class="c1">########################################] | 100% Completed |  0.5s</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">collections</span><span class="o">.</span><span class="n">PathCollection</span> <span class="n">at</span> <span class="mh">0x1c2b43c5f8</span><span class="o">&gt;</span>
</pre></div>
</div>
<img alt="../_images/CMAQ_hi_volcano_29_2.png" src="../_images/CMAQ_hi_volcano_29_2.png" />
<div class="code python highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">df_so2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_so2</span><span class="o">.</span><span class="n">obs</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span>
<span class="n">p</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">61.45120441800254</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="NESDIS_VIIRS_AOD.html" class="btn btn-neutral float-right" title="NOAA NESDIS AOD" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="improve_trends_kmeans.html" class="btn btn-neutral float-left" title="Loading IMPROVE Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Barry Baker

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>